{% extends 'partials/base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% load widget_tweaks %}
<html>
<head>
{% block title %}Producto Critico Update{% endblock %}
</head>
<body>
{% block content %}
<hr>
<hr>
<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card shadow-sm">
                <div class="card-header ">
                    <h3 class="mb-0">Actualizar Producto Crítico</h3>
                </div>
                <div class="card-body">
                    <!-- Información del producto -->
                    <div class="mb-4">
                        <label class="form-label"><strong>Código:</strong> {{ item.codigo }}</label><br>
                        <label class="form-label"><strong>Producto:</strong> {{ item.nombre }}</label>
                    </div>
                    
                    <!-- Formulario principal -->
                    <form method="POST" id="ProductForm" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="form-check form-switch mb-3">
                            {{ form.rev_calidad }}
                            <label class="form-check-label" for="rev_calidad">Revisión de Calidad</label>
                        </div>
                        
                        <div class="d-flex justify-content-end mt-4">
                            <a class="btn btn-outline-secondary me-2" href="{% url 'product_calidad' %}">Cancelar</a>
                            <input type="submit" id="submit-button" class="btn btn-outline-info" value="Actualizar">
                        </div>
                    </form>
                    <hr>
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#requerimientoModal">
                        <i class="fa fa-plus me-1"></i> Añadir Requerimiento de Calidad
                    </button>


                    <!-- Lista de Requerimientos -->
                    <h5 class="mt-5">Requerimientos de Calidad:</h5>
                    <ul id="requerimientos-list" class="list-group">
                        {% for requerimiento in producto_calidad.requerimientos_calidad.all %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                {{ requerimiento.nombre }} - {{ requerimiento.fecha }}
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal para Añadir Requerimiento de Calidad -->
<div class="modal fade" id="requerimientoModal" tabindex="-1" aria-labelledby="requerimientoModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="requerimientoModalLabel">Añadir Requerimiento de Calidad</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="requerimientoForm">
                    {% csrf_token %}
                    {{ req_form.nombre|add_class:"form-control mb-3" }}
                    {{ req_form.url|add_class:"form-control mb-3" }}
                    <button type="submit" class="btn btn-primary">Guardar</button>
                </form>
            </div>
        </div>
    </div>
</div>
<div id="loadingIndicator" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000;">
    <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; flex-direction: row; align-items: center; justify-content: center;">
        <img src="{% static 'images/SAVIA_Logo.png' %}" alt="Logo" style="width: 100px; height: 100px; border-radius: 50%; margin-right: 10px;">
        <p style="color: white; margin: 0;">Generando reporte, por favor espera...&nbsp;<i class="fa-solid fa-mug-hot"></i></p>
    </div>
</div>
</body>
</html>
<!--AJAX CALL-->
<script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
// Función para mostrar el indicador de carga y evitar el doble clic
document.getElementById('ProductForm').addEventListener('submit', function(event) {
    event.preventDefault(); // Previene el envío inmediato

    // Mostrar el indicador de carga
    document.getElementById('loadingIndicator').style.display = 'block';

    // Desactivar el botón de envío para evitar doble clic
    var btn = document.getElementById('submit-button');
    btn.disabled = true;
    btn.classList.add('d-none');

    // Después de una breve pausa, envía el formulario
    setTimeout(() => {
        this.submit();
    }, 50);
});

document.getElementById('requerimientoForm').addEventListener('submit', function(event) {
    event.preventDefault();
    var formData = new FormData(this);

    fetch("{% url 'add_requerimiento_calidad' item.id %}", {
        method: "POST",
        body: formData,
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
        },
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Cerrar el modal y resetear el formulario
            $('#requerimientoModal').modal('hide');
            this.reset();
            
            // Añadir el nuevo requerimiento a la lista
            const requerimientosList = document.getElementById('requerimientos-list');
            const newRequerimiento = document.createElement('li');
            newRequerimiento.textContent = `${data.nombre} - ${data.fecha}`;
            requerimientosList.appendChild(newRequerimiento);
        } else {
            console.error('Error:', data.errors);
            alert('Error al añadir el requerimiento. Por favor, revisa el formulario.');
        }
    })
    .catch(error => console.error('Error:', error));
});

</script>
{% endblock %}
