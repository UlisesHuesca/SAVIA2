{% extends 'partials/base.html' %}
{% load crispy_forms_tags %}
{% load static %}
{% load widget_tweaks %}

{% block title %}Hist√≥rico de Solicitudes de Precio de Referencia{% endblock %}

{% block content %}
<h6>&nbsp;</h6>
<h6>&nbsp;</h6>
<h6>&nbsp;</h6>
<!-- (Opcional) Filtros arriba si usas django-filter -->
{% if myfilter %}
<div class="col-sm-12 my-3">
  <div class="card">
    <div class="card-header"><h5>Filtro de solicitudes</h5></div>
    <div class="card-body">
      <form method="GET" class="row g-3">
        <div class="col-lg-4">
          <div class="form-floating">
            {{ myfilter.form.solicitado_por|add_class:"form-control"|append_attr:"placeholder=Solicitado por" }}
            <label>Solicitado por</label>
          </div>
        </div>
        <div class="col-lg-4">
          <div class="form-floating">
            {{ myfilter.form.product|add_class:"form-control"|append_attr:"placeholder=Producto" }}
            <label>Producto</label>
          </div>
        </div>
        <div class="col-lg-2">
          <div class="form-floating">
            {% render_field myfilter.form.start_date type="date" class="form-control" %}
            <label>Desde</label>
          </div>
        </div>
        <div class="col-lg-2">
          <div class="form-floating">
            {% render_field myfilter.form.end_date type="date" class="form-control" %}
            <label>Hasta</label>
          </div>
        </div>
        <div class="col-auto">
          <button class="btn btn-outline-success mt-1" type="submit">
            <i class="fa-solid fa-magnifying-glass"></i>
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endif %}

<div class="card mt-3">
  <div class="card-header d-flex justify-content-between">
    <h5 class="mb-0">Solicitudes procesadas</h5>
    <span class="badge bg-secondary">{{ solicitudes|length }}</span>
  </div>
  <div class="card-body table-responsive">
    <table class="table table-striped table-hover bg-white">
      <thead class="text-black" style="background:#F5F5F5;">
        <tr>
          <th>Producto</th>
          <th>Precio vigente</th>
          <th>%</th>
          <th>Solicitado por</th>
          <th>Procesado por</th>
          <th>Solicitado</th>
          <th>Procesado</th>
          <th>Estatus</th>
          <th>Motivo</th>
          <th>Registro</th>
        </tr>
      </thead>
      <tbody>
        {% for c in solicitudes %}
        <tr>
          <td>{{ c.product.nombre }}</td>
          <td>${{ c.new_value }}</td>
          <td>{% widthratio c.new_porcentaje 1 100 as pct %}{{ pct|floatformat:2 }}%</td>
          <td>{{ c.solicitado_por.staff.staff.first_name }} {{c.solicitado_por.staff.staff.last_name}}</td>
          <td>{{ c.autorizado_por.staff.staff.first_name }} {{c.solicitado_por.staff.staff.last_name}}</td>
          <td>{{ c.solicitado_en|date:"d/m/Y H:i" }}</td>
          <td>{{ c.autorizado_en|date:"d/m/Y H:i" }}</td>
          <td>
            {% if c.autorizado %}
              <span class="badge bg-success">Autorizada</span>
            {% else %}
              <span class="badge bg-danger">Cancelada/Rechazada</span>
            {% endif %}
          </td>
          <td>{{ c.motivo }}</td>
          <td>
            <a class="btn btn-outline-danger" href="{% url 'precio_ref_pdf' c.id %}" target="_blank" >
                <i class="fa-duotone fa-solid fa-file-pdf"></i>
            </a>
          </td>
        </tr>
        {% empty %}
        <tr><td colspan="10" class="text-center">Sin registros procesados</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
